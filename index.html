<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä»Šæ—¥å¿ƒæƒ…æ‰“å¡</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 30px;
            padding: 50px 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 600px;
            width: 100%;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            color: #666;
            margin-bottom: 40px;
            font-size: 1.1em;
        }

        .mood-buttons {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-bottom: 40px;
            flex-wrap: wrap;
        }

        .mood-btn {
            background: white;
            border: 3px solid #e0e0e0;
            border-radius: 20px;
            padding: 25px 30px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 4em;
            width: 120px;
            height: 120px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .mood-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .mood-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .mood-btn:hover {
            transform: scale(1.15) rotate(5deg);
            border-color: #667eea;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .mood-btn:active {
            transform: scale(1.05) rotate(-2deg);
            transition: all 0.1s;
        }

        .mood-btn.happy {
            border-color: #ffd700;
        }

        .mood-btn.happy:hover {
            border-color: #ffb347;
            box-shadow: 0 8px 25px rgba(255, 179, 71, 0.4);
        }

        .mood-btn.neutral {
            border-color: #87ceeb;
        }

        .mood-btn.neutral:hover {
            border-color: #4682b4;
            box-shadow: 0 8px 25px rgba(70, 130, 180, 0.4);
        }

        .mood-btn.sad {
            border-color: #dda0dd;
        }

        .mood-btn.sad:hover {
            border-color: #ba55d3;
            box-shadow: 0 8px 25px rgba(186, 85, 211, 0.4);
        }

        .mood-btn.selected {
            transform: scale(1.1);
            border-width: 4px;
            animation: pulse 1s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
            }
            50% {
                box-shadow: 0 0 0 15px rgba(102, 126, 234, 0);
            }
        }

        .message-container {
            min-height: 100px;
            margin-top: 30px;
        }

        .message {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            border-radius: 15px;
            font-size: 1.3em;
            font-weight: 500;
            line-height: 1.6;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            animation: slideUp 0.5s ease-out;
            opacity: 0;
            transform: translateY(20px);
        }

        .message.show {
            opacity: 1;
            transform: translateY(0);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .emoji-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 10px;
            font-weight: 500;
        }

        .mood-btn-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* åŸå› é€‰æ‹©ç•Œé¢æ ·å¼ */
        .reason-selection {
            display: none;
            animation: fadeIn 0.5s ease-out;
        }

        .reason-selection.show {
            display: block;
        }

        .reason-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .reason-btn {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            font-size: 1em;
            color: #333;
            font-weight: 500;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }

        .reason-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(186, 85, 211, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .reason-btn:hover::before {
            width: 200px;
            height: 200px;
        }

        .reason-btn:hover {
            transform: scale(1.05);
            border-color: #ba55d3;
            box-shadow: 0 5px 20px rgba(186, 85, 211, 0.3);
        }

        .reason-btn:active {
            transform: scale(0.98);
        }

        .reason-btn.selected {
            background: linear-gradient(135deg, #ba55d3 0%, #9370db 100%);
            color: white;
            border-color: #ba55d3;
            transform: scale(1.05);
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #ba55d3;
            color: #ba55d3;
            border-radius: 20px;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            margin-top: 20px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: #ba55d3;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(186, 85, 211, 0.3);
        }

        .mood-selection {
            display: block;
        }

        .mood-selection.hidden {
            display: none;
        }

        /* æ‰“å¡æé†’æ ·å¼ */
        .checkin-reminder {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
            color: #333;
            padding: 15px 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(255, 179, 71, 0.3);
            animation: slideDown 0.5s ease-out;
        }

        .checkin-reminder.completed {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .streak-info {
            font-size: 0.9em;
            margin-top: 8px;
            opacity: 0.9;
        }

        /* å¿ƒæƒ…å†å²å›¾è¡¨æ ·å¼ */
        .history-section {
            margin-top: 30px;
            padding-top: 30px;
            border-top: 2px dashed #e0e0e0;
        }

        .history-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #333;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .chart-bars {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 150px;
            gap: 8px;
        }

        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, #667eea 0%, #764ba2 100%);
            border-radius: 8px 8px 0 0;
            min-width: 30px;
            position: relative;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }

        .chart-bar.happy {
            background: linear-gradient(to top, #ffd700 0%, #ffb347 100%);
        }

        .chart-bar.neutral {
            background: linear-gradient(to top, #87ceeb 0%, #4682b4 100%);
        }

        .chart-bar.sad {
            background: linear-gradient(to top, #dda0dd 0%, #ba55d3 100%);
        }

        .chart-bar.empty {
            background: #f0f0f0;
        }

        .chart-label {
            margin-top: 8px;
            font-size: 0.85em;
            color: #666;
        }

        .stats-summary {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .stat-item {
            background: rgba(255, 255, 255, 0.9);
            padding: 15px 20px;
            border-radius: 12px;
            flex: 1;
            min-width: 120px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .stat-value {
            font-size: 1.8em;
            font-weight: 700;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
        }

        .view-history-btn {
            background: rgba(102, 126, 234, 0.1);
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 20px;
            padding: 10px 25px;
            cursor: pointer;
            font-size: 0.95em;
            font-weight: 500;
            margin-top: 15px;
            transition: all 0.3s;
        }

        .view-history-btn:hover {
            background: #667eea;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        /* æƒ…æ„Ÿé™ªä¼´å°åŠ©æ‰‹æ ·å¼ */
        .assistant-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        .assistant-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2em;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .assistant-avatar:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .assistant-avatar.typing {
            animation: pulse 1s ease-in-out infinite;
        }

        .assistant-chat-window {
            position: absolute;
            bottom: 70px;
            right: 0;
            width: 350px;
            max-height: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            animation: fadeInUp 0.3s ease-out;
        }

        .assistant-chat-window.show {
            display: flex;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-header-title {
            font-weight: 600;
            font-size: 1em;
        }

        .chat-close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .chat-close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 350px;
        }

        .chat-message {
            display: flex;
            gap: 10px;
            animation: fadeIn 0.3s ease-out;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            flex-shrink: 0;
        }

        .chat-message.assistant .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .chat-message.user .message-avatar {
            background: linear-gradient(135deg, #ffd700 0%, #ffb347 100%);
        }

        .message-content {
            max-width: 75%;
            padding: 12px 15px;
            border-radius: 18px;
            font-size: 0.9em;
            line-height: 1.5;
            word-wrap: break-word;
        }

        .chat-message.assistant .message-content {
            background: #f0f0f0;
            color: #333;
            border-bottom-left-radius: 4px;
        }

        .chat-message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 12px 15px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #999;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input-container {
            padding: 15px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 20px;
            font-size: 0.9em;
            font-family: inherit;
            resize: none;
            max-height: 100px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            font-size: 1.2em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            flex-shrink: 0;
        }

        .chat-send-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .chat-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .api-config-btn {
            position: absolute;
            top: 10px;
            right: 50px;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            cursor: pointer;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .api-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .api-config-modal.show {
            display: flex;
        }

        .api-config-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .api-config-title {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
        }

        .api-option {
            margin-bottom: 20px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .api-option:hover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }

        .api-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .api-option-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }

        .api-option-desc {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 10px;
        }

        .api-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.9em;
            margin-top: 10px;
            transition: all 0.3s;
        }

        .api-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .api-option.selected .api-input {
            border-color: #667eea;
        }

        .api-option.selected .api-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.2);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* æƒ…æ„Ÿæ—¥è®°æ ·å¼ */
        .diary-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed #e0e0e0;
        }

        .diary-input-container {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            padding: 20px;
            margin-top: 15px;
        }

        .diary-textarea {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            font-size: 1em;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.3s;
        }

        .diary-textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .diary-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .diary-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            font-size: 0.95em;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s;
        }

        .diary-btn.save {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .diary-btn.save:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .diary-btn.cancel {
            background: #f0f0f0;
            color: #666;
        }

        .diary-btn.cancel:hover {
            background: #e0e0e0;
        }

        .diary-entry {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid #667eea;
        }

        .diary-date {
            font-size: 0.85em;
            color: #999;
            margin-bottom: 8px;
        }

        .diary-content {
            color: #333;
            line-height: 1.6;
            white-space: pre-wrap;
        }

        .diary-mood-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 8px;
            background: #f0f0f0;
            color: #666;
        }

        /* å¿ƒæƒ…éŸ³ä¹æ¨èæ ·å¼ */
        .music-section {
            margin-top: 25px;
            padding-top: 25px;
            border-top: 2px dashed #e0e0e0;
        }

        .music-recommendations {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }

        .music-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
            border: 2px solid transparent;
        }

        .music-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: #667eea;
        }

        .music-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .music-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .music-description {
            font-size: 0.85em;
            color: #666;
        }

        .music-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 20px;
            text-decoration: none;
            font-size: 0.9em;
            transition: all 0.3s;
        }

        .music-link:hover {
            transform: scale(1.05);
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.4);
        }
    </style>
</head>
<body>
    <!-- æƒ…æ„Ÿé™ªä¼´å°åŠ©æ‰‹ -->
    <div class="assistant-container">
        <div class="assistant-avatar" id="assistantAvatar" onclick="toggleChatWindow()">
            ğŸ¤—
        </div>
        <div class="assistant-chat-window" id="chatWindow">
            <div class="chat-header">
                <div class="chat-header-title">ğŸ¤— æƒ…æ„Ÿé™ªä¼´åŠ©æ‰‹</div>
                <button class="api-config-btn" onclick="showApiConfig()" title="APIè®¾ç½®">âš™ï¸</button>
                <button class="chat-close-btn" onclick="closeChatWindow()">Ã—</button>
            </div>
            <div class="chat-messages" id="chatMessages"></div>
            <div class="chat-input-container">
                <textarea class="chat-input" id="chatInput" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1" onkeydown="handleChatInputKey(event)"></textarea>
                <button class="chat-send-btn" id="chatSendBtn" onclick="sendChatMessage()">â¤</button>
            </div>
        </div>
    </div>

    <!-- APIé…ç½®å¼¹çª— -->
    <div class="api-config-modal" id="apiConfigModal" onclick="event.target === this && closeApiConfig()">
        <div class="api-config-content">
            <div class="api-config-title">âš™ï¸ AIæ¨¡å‹é…ç½®</div>
            
            <div class="api-option" onclick="selectApiOption('ollama')">
                <div class="api-option-title">ğŸ–¥ï¸ Ollama (æœ¬åœ°è¿è¡Œ)</div>
                <div class="api-option-desc">å®Œå…¨å…è´¹ï¼Œæ•°æ®ä¸ä¸Šä¼ ï¼Œéœ€è¦åœ¨æœ¬åœ°å®‰è£…Ollama</div>
                <input type="text" class="api-input" id="ollamaUrl" placeholder="APIåœ°å€ï¼Œå¦‚: http://localhost:11434/api/chat" value="http://localhost:11434/api/chat">
                <input type="text" class="api-input" id="ollamaModel" placeholder="æ¨¡å‹åç§°ï¼Œå¦‚: llama3.2" value="llama3.2" style="margin-top: 10px;">
            </div>

            <div class="api-option" onclick="selectApiOption('huggingface')">
                <div class="api-option-title">ğŸ¤— Hugging Face (åœ¨çº¿) - é»˜è®¤æ¨è</div>
                <div class="api-option-desc">âœ¨ é€šè¿‡Gitéƒ¨ç½²åï¼Œä»£ç†ä¼šè‡ªåŠ¨å¤„ç†API Keyï¼Œæ— éœ€æ‰‹åŠ¨é…ç½®ï¼<br>ğŸ’¡ å¦‚éœ€æ‰‹åŠ¨é…ç½®æˆ–ä½¿ç”¨è‡ªå·±çš„Tokenï¼Œå¯å¡«å†™ä¸‹æ–¹Access Tokenï¼ˆå¯é€‰ï¼‰</div>
                <div style="margin-bottom: 10px;">
                    <a href="https://huggingface.co/settings/tokens" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.85em;">
                        ğŸ”— ç‚¹å‡»è¿™é‡Œè·å–Hugging Face Access Tokenï¼ˆå…è´¹ï¼Œå¯é€‰ï¼‰
                    </a>
                </div>
                <input type="text" class="api-input" id="hfApiKey" placeholder="ï¼ˆå¯é€‰ï¼‰ç²˜è´´ä½ çš„Hugging Face Access Tokenï¼ˆæ ¼å¼ï¼šhf_xxxxxï¼‰">
                <input type="text" class="api-input" id="hfModel" placeholder="æ¨¡å‹ID" value="meta-llama/Llama-3.2-3B-Instruct" style="margin-top: 10px;">
            </div>

            <div class="api-option" onclick="selectApiOption('groq')">
                <div class="api-option-title">âš¡ Groq (å¿«é€Ÿ) - é»˜è®¤æ¨è</div>
                <div class="api-option-desc">å“åº”å¿«é€Ÿï¼Œå…è´¹é¢åº¦å……è¶³ï¼Œéœ€è¦API Key</div>
                <div style="margin-bottom: 10px;">
                    <a href="https://console.groq.com/keys" target="_blank" style="color: #667eea; text-decoration: none; font-size: 0.85em;">
                        ğŸ”— ç‚¹å‡»è¿™é‡Œè·å–Groq API Keyï¼ˆå…è´¹ï¼‰
                    </a>
                </div>
                <input type="text" class="api-input" id="groqApiKey" placeholder="ç²˜è´´ä½ çš„Groq API Keyï¼ˆæ ¼å¼ï¼šgsk_xxxxxï¼‰">
                <input type="text" class="api-input" id="groqModel" placeholder="æ¨¡å‹åç§°" value="llama-3.1-8b-instant" style="margin-top: 10px;">
            </div>

            <div class="api-option" onclick="selectApiOption('openai')">
                <div class="api-option-title">ğŸ”· OpenAI (éœ€ä»˜è´¹)</div>
                <div class="api-option-desc">é«˜è´¨é‡ï¼Œéœ€è¦API Keyå’Œä»˜è´¹</div>
                <input type="text" class="api-input" id="openaiApiKey" placeholder="OpenAI API Key">
                <input type="text" class="api-input" id="openaiModel" placeholder="æ¨¡å‹åç§°ï¼Œå¦‚: gpt-3.5-turbo" value="gpt-3.5-turbo" style="margin-top: 10px;">
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="diary-btn save" onclick="saveApiConfig()" style="flex: 1;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="diary-btn cancel" onclick="closeApiConfig()" style="flex: 1;">å–æ¶ˆ</button>
            </div>
        </div>
    </div>

    <div class="container">
        <h1>âœ¨ ä»Šæ—¥å¿ƒæƒ…æ‰“å¡ âœ¨</h1>
        
        <!-- æ‰“å¡æé†’ -->
        <div id="checkinReminder" class="checkin-reminder"></div>
        
        <!-- å¿ƒæƒ…é€‰æ‹©ç•Œé¢ -->
        <div id="moodSelection" class="mood-selection">
            <p class="subtitle">é€‰æ‹©ä½ æ­¤åˆ»çš„å¿ƒæƒ…å§ï½</p>
            
            <div class="mood-buttons">
                <div class="mood-btn-wrapper">
                    <button class="mood-btn happy" data-mood="happy" aria-label="å¼€å¿ƒ">
                        ğŸ˜Š
                    </button>
                    <span class="emoji-label">å¼€å¿ƒ</span>
                </div>
                
                <div class="mood-btn-wrapper">
                    <button class="mood-btn neutral" data-mood="neutral" aria-label="ä¸€èˆ¬">
                        ğŸ˜
                    </button>
                    <span class="emoji-label">ä¸€èˆ¬</span>
                </div>
                
                <div class="mood-btn-wrapper">
                    <button class="mood-btn sad" data-mood="sad" aria-label="éš¾è¿‡">
                        ğŸ˜¢
                    </button>
                    <span class="emoji-label">éš¾è¿‡</span>
                </div>
            </div>
        </div>

        <!-- åŸå› é€‰æ‹©ç•Œé¢ -->
        <div id="reasonSelection" class="reason-selection">
            <p class="subtitle">ğŸ’œ èƒ½å‘Šè¯‰æˆ‘ä¸ºä»€ä¹ˆéš¾è¿‡å—ï¼Ÿ</p>
            
            <div class="reason-buttons">
                <button class="reason-btn" data-reason="work">ğŸ’¼ å·¥ä½œå‹åŠ›</button>
                <button class="reason-btn" data-reason="relationship">ğŸ‘¥ äººé™…å…³ç³»</button>
                <button class="reason-btn" data-reason="emotion">ğŸ’” æƒ…æ„Ÿé—®é¢˜</button>
                <button class="reason-btn" data-reason="health">ğŸ¥ å¥åº·é—®é¢˜</button>
                <button class="reason-btn" data-reason="study">ğŸ“š å­¦ä¹ å‹åŠ›</button>
                <button class="reason-btn" data-reason="other">ğŸ’­ å…¶ä»–åŸå› </button>
            </div>

            <button class="back-btn" id="backToMood">â† è¿”å›é€‰æ‹©å¿ƒæƒ…</button>
        </div>
        
        <div class="message-container">
            <div id="message" class="message"></div>
        </div>

        <!-- æƒ…æ„Ÿæ—¥è®°åŠŸèƒ½ -->
        <div id="diarySection" class="diary-section" style="display: none;">
            <div class="history-title">ğŸ“ è®°å½•ä»Šå¤©çš„å¿ƒæƒ…</div>
            <div class="diary-input-container">
                <textarea id="diaryTextarea" class="diary-textarea" placeholder="å†™ä¸‹ä»Šå¤©çš„å¿ƒæƒ…ã€æƒ³æ³•æˆ–æ„Ÿå—å§..."></textarea>
                <div class="diary-buttons">
                    <button class="diary-btn save" onclick="saveDiary()">ğŸ’¾ ä¿å­˜æ—¥è®°</button>
                    <button class="diary-btn cancel" onclick="cancelDiary()">å–æ¶ˆ</button>
                </div>
            </div>
            <div id="diaryEntries" style="margin-top: 20px;"></div>
        </div>

        <!-- å¿ƒæƒ…éŸ³ä¹æ¨è -->
        <div id="musicSection" class="music-section" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div class="history-title" style="margin: 0;">ğŸµ ä¸ºä½ æ¨èéŸ³ä¹</div>
                <button class="back-btn" onclick="hideMusicRecommendations()" style="margin: 0; padding: 8px 15px; font-size: 0.85em;">å…³é—­</button>
            </div>
            <div id="musicRecommendations" class="music-recommendations"></div>
        </div>

        <!-- å¿ƒæƒ…å†å²è®°å½• -->
        <div id="historySection" class="history-section" style="display: none;">
            <div class="history-title">ğŸ“Š æœ€è¿‘7å¤©å¿ƒæƒ…è®°å½•</div>
            <div class="chart-container">
                <div id="chartBars" class="chart-bars"></div>
                <div id="chartLabels" style="display: flex; justify-content: space-around; margin-top: 8px;"></div>
            </div>
            <div class="stats-summary">
                <div class="stat-item">
                    <div id="happyStat" class="stat-value">0</div>
                    <div class="stat-label">ğŸ˜Š å¼€å¿ƒ</div>
                </div>
                <div class="stat-item">
                    <div id="neutralStat" class="stat-value">0</div>
                    <div class="stat-label">ğŸ˜ ä¸€èˆ¬</div>
                </div>
                <div class="stat-item">
                    <div id="sadStat" class="stat-value">0</div>
                    <div class="stat-label">ğŸ˜¢ éš¾è¿‡</div>
                </div>
            </div>
            <button class="view-history-btn" onclick="toggleHistory()">éšè—å†å²è®°å½•</button>
        </div>
    </div>

    <script>
        // æ•°æ®å­˜å‚¨å’Œç®¡ç†
        const Storage = {
            getMoodHistory: () => {
                const history = localStorage.getItem('moodHistory');
                return history ? JSON.parse(history) : [];
            },
            saveMoodHistory: (history) => {
                localStorage.setItem('moodHistory', JSON.stringify(history));
            },
            getLastCheckinDate: () => {
                return localStorage.getItem('lastCheckinDate');
            },
            setLastCheckinDate: (date) => {
                localStorage.setItem('lastCheckinDate', date);
            },
            getStreak: () => {
                return parseInt(localStorage.getItem('checkinStreak') || '0');
            },
            setStreak: (streak) => {
                localStorage.setItem('checkinStreak', streak.toString());
            },
            getDiaries: () => {
                const diaries = localStorage.getItem('diaries');
                return diaries ? JSON.parse(diaries) : [];
            },
            saveDiaries: (diaries) => {
                localStorage.setItem('diaries', JSON.stringify(diaries));
            },
            getCurrentMood: () => {
                return localStorage.getItem('currentMood');
            },
            setCurrentMood: (mood) => {
                localStorage.setItem('currentMood', mood);
            }
        };

        // è·å–ä»Šå¤©çš„æ—¥æœŸå­—ç¬¦ä¸² (YYYY-MM-DD)
        function getTodayString() {
            const today = new Date();
            return `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;
        }

        // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æ‰“å¡
        function hasCheckedInToday() {
            return Storage.getLastCheckinDate() === getTodayString();
        }

        // æ›´æ–°è¿ç»­æ‰“å¡å¤©æ•°
        function updateStreak() {
            const lastDate = Storage.getLastCheckinDate();
            const today = getTodayString();
            let streak = Storage.getStreak();

            if (!lastDate) {
                // ç¬¬ä¸€æ¬¡æ‰“å¡
                streak = 1;
            } else {
                const lastDateObj = new Date(lastDate);
                const todayObj = new Date(today);
                const diffDays = Math.floor((todayObj - lastDateObj) / (1000 * 60 * 60 * 24));

                if (diffDays === 0) {
                    // åŒä¸€å¤©ï¼Œä¸å¢åŠ 
                } else if (diffDays === 1) {
                    // è¿ç»­æ‰“å¡
                    streak += 1;
                } else {
                    // ä¸­æ–­äº†ï¼Œé‡ç½®
                    streak = 1;
                }
            }

            Storage.setStreak(streak);
            Storage.setLastCheckinDate(today);
            return streak;
        }

        // ä¿å­˜å¿ƒæƒ…è®°å½•
        function saveMoodRecord(mood, reason = null) {
            const history = Storage.getMoodHistory();
            const today = getTodayString();
            
            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰è®°å½•ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°
            const todayIndex = history.findIndex(record => record.date === today);
            const record = {
                date: today,
                mood: mood,
                reason: reason,
                timestamp: new Date().getTime()
            };

            if (todayIndex >= 0) {
                history[todayIndex] = record;
            } else {
                history.push(record);
            }

            // åªä¿ç•™æœ€è¿‘30å¤©çš„è®°å½•
            const recentHistory = history.slice(-30);
            Storage.saveMoodHistory(recentHistory);
        }

        // æ˜¾ç¤ºæ‰“å¡æé†’
        function showCheckinReminder() {
            const reminder = document.getElementById('checkinReminder');
            const hasCheckedIn = hasCheckedInToday();
            const streak = Storage.getStreak();

            if (hasCheckedIn) {
                reminder.className = 'checkin-reminder completed';
                reminder.innerHTML = `
                    âœ… ä»Šæ—¥å·²æ‰“å¡å®Œæˆï¼
                    <div class="streak-info">ğŸ”¥ è¿ç»­æ‰“å¡ ${streak} å¤©</div>
                `;
            } else {
                reminder.className = 'checkin-reminder';
                const lastDate = Storage.getLastCheckinDate();
                if (lastDate && streak > 0) {
                    reminder.innerHTML = `
                        ğŸ“ ä»Šå¤©è¿˜æ²¡æ‰“å¡å“¦ï½å¿«æ¥è®°å½•ä½ çš„å¿ƒæƒ…å§ï¼
                        <div class="streak-info">ğŸ”¥ å½“å‰è¿ç»­æ‰“å¡ ${streak} å¤©ï¼Œä¸è¦ä¸­æ–­å“¦ï½</div>
                    `;
                } else {
                    reminder.innerHTML = `
                        ğŸ“ ä»Šå¤©è¿˜æ²¡æ‰“å¡å“¦ï½å¿«æ¥è®°å½•ä½ çš„å¿ƒæƒ…å§ï¼
                        <div class="streak-info">å¼€å§‹ä½ çš„å¿ƒæƒ…æ‰“å¡ä¹‹æ—…å§ï¼</div>
                    `;
                }
            }
        }

        // æ¸²æŸ“å¿ƒæƒ…å†å²å›¾è¡¨
        function renderHistoryChart() {
            const history = Storage.getMoodHistory();
            const chartBars = document.getElementById('chartBars');
            const chartLabels = document.getElementById('chartLabels');
            
            // è·å–æœ€è¿‘7å¤©çš„æ•°æ®
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                const record = history.find(r => r.date === dateStr);
                last7Days.push({
                    date: dateStr,
                    mood: record ? record.mood : null,
                    displayDate: `${date.getMonth() + 1}/${date.getDate()}`
                });
            }

            // è®¡ç®—æœ€å¤§é«˜åº¦ï¼ˆç”¨äºå½’ä¸€åŒ–ï¼‰
            const moodValues = { happy: 3, neutral: 2, sad: 1 };
            const maxValue = 3;

            // æ¸…ç©ºå›¾è¡¨
            chartBars.innerHTML = '';
            chartLabels.innerHTML = '';

            // æ¸²æŸ“æŸ±çŠ¶å›¾
            last7Days.forEach(day => {
                const bar = document.createElement('div');
                const label = document.createElement('div');
                
                if (day.mood) {
                    const value = moodValues[day.mood];
                    const height = (value / maxValue) * 100;
                    bar.className = `chart-bar ${day.mood}`;
                    bar.style.height = `${height}%`;
                    bar.title = `${day.displayDate}: ${day.mood === 'happy' ? 'å¼€å¿ƒ' : day.mood === 'neutral' ? 'ä¸€èˆ¬' : 'éš¾è¿‡'}`;
                } else {
                    bar.className = 'chart-bar empty';
                    bar.style.height = '10%';
                    bar.title = `${day.displayDate}: æœªæ‰“å¡`;
                }
                
                label.className = 'chart-label';
                label.textContent = day.displayDate;
                
                chartBars.appendChild(bar);
                chartLabels.appendChild(label);
            });

            // æ›´æ–°ç»Ÿè®¡
            updateStats(history);
        }

        // æ›´æ–°ç»Ÿè®¡æ•°æ®
        function updateStats(history) {
            const last7Days = history.slice(-7);
            const stats = {
                happy: last7Days.filter(r => r.mood === 'happy').length,
                neutral: last7Days.filter(r => r.mood === 'neutral').length,
                sad: last7Days.filter(r => r.mood === 'sad').length
            };

            document.getElementById('happyStat').textContent = stats.happy;
            document.getElementById('neutralStat').textContent = stats.neutral;
            document.getElementById('sadStat').textContent = stats.sad;
        }

        // åˆ‡æ¢å†å²è®°å½•æ˜¾ç¤º
        function toggleHistory() {
            const historySection = document.getElementById('historySection');
            const btn = event.target;
            const allViewBtns = document.querySelectorAll('.view-history-btn');
            
            if (historySection.style.display === 'none' || historySection.style.display === '') {
                historySection.style.display = 'block';
                renderHistoryChart();
                // æ›´æ–°æ‰€æœ‰æŸ¥çœ‹æŒ‰é’®çš„æ–‡æœ¬
                allViewBtns.forEach(b => {
                    if (!b.closest('.history-section')) {
                        b.textContent = 'éšè—å†å²è®°å½•';
                    }
                });
            } else {
                historySection.style.display = 'none';
                // æ›´æ–°æ‰€æœ‰æŸ¥çœ‹æŒ‰é’®çš„æ–‡æœ¬
                allViewBtns.forEach(b => {
                    if (!b.closest('.history-section')) {
                        b.textContent = 'ğŸ“Š æŸ¥çœ‹å†å²è®°å½•';
                    }
                });
            }
        }

        // ========== æƒ…æ„Ÿæ—¥è®°åŠŸèƒ½ ==========
        function showDiarySection() {
            const diarySection = document.getElementById('diarySection');
            diarySection.style.display = 'block';
            document.getElementById('diaryTextarea').focus();
            loadDiaryEntries();
        }

        function hideDiarySection() {
            const diarySection = document.getElementById('diarySection');
            diarySection.style.display = 'none';
            document.getElementById('diaryTextarea').value = '';
        }

        function saveDiary() {
            const content = document.getElementById('diaryTextarea').value.trim();
            if (!content) {
                alert('è¯·è¾“å…¥æ—¥è®°å†…å®¹ï½');
                return;
            }

            const diaries = Storage.getDiaries();
            const today = getTodayString();
            const currentMood = Storage.getCurrentMood() || 'unknown';

            const diary = {
                date: today,
                content: content,
                mood: currentMood,
                timestamp: new Date().getTime()
            };

            // æ£€æŸ¥ä»Šå¤©æ˜¯å¦å·²æœ‰æ—¥è®°ï¼Œå¦‚æœæœ‰åˆ™æ›´æ–°
            const todayIndex = diaries.findIndex(d => d.date === today);
            if (todayIndex >= 0) {
                diaries[todayIndex] = diary;
            } else {
                diaries.push(diary);
            }

            // åªä¿ç•™æœ€è¿‘30å¤©çš„æ—¥è®°
            const recentDiaries = diaries.slice(-30);
            Storage.saveDiaries(recentDiaries);

            hideDiarySection();
            loadDiaryEntries();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            const messageElement = document.getElementById('message');
            messageElement.classList.remove('show');
            setTimeout(() => {
                messageElement.textContent = 'ğŸ’¾ æ—¥è®°å·²ä¿å­˜ï¼ä½ çš„å¿ƒæƒ…è®°å½•ä¸‹æ¥äº†ï½';
                messageElement.classList.add('show');
            }, 50);
        }

        function cancelDiary() {
            hideDiarySection();
        }

        function loadDiaryEntries() {
            const diaries = Storage.getDiaries();
            const entriesContainer = document.getElementById('diaryEntries');
            
            if (diaries.length === 0) {
                entriesContainer.innerHTML = '<p style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•ï¼Œå¼€å§‹è®°å½•ä½ çš„å¿ƒæƒ…å§ï½</p>';
                return;
            }

            // æ˜¾ç¤ºæœ€è¿‘7å¤©çš„æ—¥è®°
            const recentDiaries = diaries.slice(-7).reverse();
            entriesContainer.innerHTML = recentDiaries.map(diary => {
                const date = new Date(diary.timestamp);
                const dateStr = `${date.getMonth() + 1}æœˆ${date.getDate()}æ—¥`;
                const moodEmoji = diary.mood === 'happy' ? 'ğŸ˜Š' : diary.mood === 'neutral' ? 'ğŸ˜' : diary.mood === 'sad' ? 'ğŸ˜¢' : 'ğŸ’­';
                const moodText = diary.mood === 'happy' ? 'å¼€å¿ƒ' : diary.mood === 'neutral' ? 'ä¸€èˆ¬' : diary.mood === 'sad' ? 'éš¾è¿‡' : 'æœªçŸ¥';
                
                return `
                    <div class="diary-entry">
                        <div class="diary-date">
                            <span class="diary-mood-tag">${moodEmoji} ${moodText}</span>
                            ${dateStr}
                        </div>
                        <div class="diary-content">${diary.content}</div>
                    </div>
                `;
            }).join('');
        }

        // ========== å¿ƒæƒ…éŸ³ä¹æ¨è ==========
        const MusicRecommendations = {
            happy: [
                { icon: 'ğŸµ', title: 'è½»å¿«æµè¡Œ', description: 'èŠ‚å¥æ˜å¿«çš„æµè¡ŒéŸ³ä¹', search: 'è½»å¿«æµè¡ŒéŸ³ä¹' },
                { icon: 'ğŸ¸', title: 'æ‘‡æ»šèƒ½é‡', description: 'å……æ»¡æ´»åŠ›çš„æ‘‡æ»šæ­Œæ›²', search: 'æ‘‡æ»šéŸ³ä¹' },
                { icon: 'ğŸ¹', title: 'ç”µå­èˆæ›²', description: 'åŠ¨æ„Ÿåè¶³çš„ç”µå­éŸ³ä¹', search: 'ç”µå­èˆæ›²' },
                { icon: 'ğŸ¤', title: 'å¿«ä¹æ°‘è°£', description: 'è½»æ¾æ„‰å¿«çš„æ°‘è°£æ­Œæ›²', search: 'å¿«ä¹æ°‘è°£' }
            ],
            neutral: [
                { icon: 'ğŸ¼', title: 'è½»éŸ³ä¹', description: 'èˆ’ç¼“æ”¾æ¾çš„çº¯éŸ³ä¹', search: 'è½»éŸ³ä¹ çº¯éŸ³ä¹' },
                { icon: 'ğŸ§', title: 'çˆµå£«ä¹', description: 'ä¼˜é›…çš„çˆµå£«æ—‹å¾‹', search: 'çˆµå£«éŸ³ä¹' },
                { icon: 'ğŸ¹', title: 'é’¢ç´æ›²', description: 'å®é™çš„é’¢ç´ç‹¬å¥', search: 'é’¢ç´æ›²' },
                { icon: 'ğŸŒŠ', title: 'è‡ªç„¶å£°éŸ³', description: 'å¤§è‡ªç„¶çš„å£°éŸ³ç–—æ„ˆ', search: 'è‡ªç„¶å£°éŸ³ ç™½å™ªéŸ³' }
            ],
            sad: [
                { icon: 'ğŸ»', title: 'æ²»æ„ˆç³»', description: 'æ¸©æš–æ²»æ„ˆçš„éŸ³ä¹', search: 'æ²»æ„ˆç³»éŸ³ä¹' },
                { icon: 'ğŸµ', title: 'æŠ’æƒ…æ­Œæ›²', description: 'æƒ…æ„Ÿä¸°å¯Œçš„æŠ’æƒ…éŸ³ä¹', search: 'æŠ’æƒ…æ­Œæ›²' },
                { icon: 'ğŸ¹', title: 'è½»éŸ³ä¹', description: 'å¹³é™å¿ƒçµçš„çº¯éŸ³ä¹', search: 'è½»éŸ³ä¹ æ”¾æ¾' },
                { icon: 'ğŸŒ™', title: 'å¤œæ™šéŸ³ä¹', description: 'é€‚åˆå¤œæ™šçš„å®‰é™éŸ³ä¹', search: 'å¤œæ™šéŸ³ä¹ å®‰é™' }
            ]
        };

        function showMusicRecommendations(mood) {
            const musicSection = document.getElementById('musicSection');
            const recommendations = MusicRecommendations[mood] || MusicRecommendations.neutral;
            const container = document.getElementById('musicRecommendations');

            container.innerHTML = recommendations.map(music => {
                // ä½¿ç”¨ç½‘æ˜“äº‘éŸ³ä¹æœç´¢é“¾æ¥
                const searchUrl = `https://music.163.com/#/search/m/?s=${encodeURIComponent(music.search)}`;
                return `
                    <div class="music-card" onclick="window.open('${searchUrl}', '_blank')">
                        <div class="music-icon">${music.icon}</div>
                        <div class="music-title">${music.title}</div>
                        <div class="music-description">${music.description}</div>
                        <a href="${searchUrl}" target="_blank" class="music-link" onclick="event.stopPropagation()">ğŸµ å»å¬å¬</a>
                    </div>
                `;
            }).join('');

            musicSection.style.display = 'block';
            
            // æ»šåŠ¨åˆ°éŸ³ä¹æ¨èåŒºåŸŸ
            setTimeout(() => {
                musicSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }, 100);
        }

        function hideMusicRecommendations() {
            const musicSection = document.getElementById('musicSection');
            musicSection.style.display = 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            showCheckinReminder();
            
            // åˆå§‹åŒ–æƒ…æ„Ÿé™ªä¼´å°åŠ©æ‰‹ï¼ˆAIèŠå¤©ç‰ˆï¼‰
            Assistant.init();
            
            // åˆå§‹åŒ–APIé…ç½®ï¼ˆé»˜è®¤ä½¿ç”¨Hugging Faceï¼Œé€šè¿‡ä»£ç†æ— éœ€API Keyï¼‰
            const config = Assistant.getApiConfig();
            // å¦‚æœproviderä¸æ˜¯huggingfaceï¼Œæˆ–è€…ä¹‹å‰é…ç½®çš„æ˜¯groqä½†æ²¡æœ‰apiKeyï¼Œå¼ºåˆ¶ä½¿ç”¨huggingface
            if (!config.provider || config.provider === 'groq' || (config.provider !== 'huggingface' && !config[config.provider]?.apiKey)) {
                config.provider = 'huggingface';
                // ç¡®ä¿huggingfaceé…ç½®å­˜åœ¨
                if (!config.huggingface) {
                    config.huggingface = { apiKey: '', model: 'meta-llama/Llama-3.2-3B-Instruct' };
                }
                Assistant.saveApiConfig(config);
            }

            // æ·»åŠ æ¬¢è¿æ¶ˆæ¯åˆ°èŠå¤©çª—å£ï¼ˆå¦‚æœèŠå¤©å†å²ä¸ºç©ºï¼‰
            const chatMessages = document.getElementById('chatMessages');
            if (Assistant.chatHistory.length === 0 && chatMessages) {
                const greeting = Assistant.getGreeting();
                const welcomeMsg = `${greeting}\n\næˆ‘æ˜¯ä½ çš„AIæƒ…æ„Ÿé™ªä¼´åŠ©æ‰‹ï¼Œä½¿ç”¨Hugging Face AIï¼ˆå…è´¹ï¼‰\n\nâœ¨ é€šè¿‡Gitéƒ¨ç½²åï¼Œæˆ‘å·²è‡ªåŠ¨é…ç½®å¥½ï¼Œå¯ä»¥ç›´æ¥å¼€å§‹èŠå¤©ï¼\n\nå¯ä»¥ç›´æ¥å’Œæˆ‘èŠèŠä½ çš„å¿ƒæƒ…ã€çƒ¦æ¼æˆ–ä»»ä½•æƒ³è¯´çš„è¯ï½\n\nğŸ’¡ æç¤ºï¼šç‚¹å‡»å³ä¸Šè§’âš™ï¸å¯ä»¥åˆ‡æ¢AIæ¨¡å‹æˆ–æ‰‹åŠ¨é…ç½®API Key`;
                addMessageToChat('assistant', welcomeMsg, false);
            }
            
            // å§‹ç»ˆæ˜¾ç¤ºå†å²è®°å½•æŒ‰é’®ï¼ˆå³ä½¿æ²¡æœ‰å†å²è®°å½•ï¼‰
            const historySection = document.getElementById('historySection');
            historySection.style.display = 'none';
            
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰æŸ¥çœ‹æŒ‰é’®ï¼Œé¿å…é‡å¤æ·»åŠ 
            let viewBtn = document.querySelector('.view-history-btn');
            if (!viewBtn || viewBtn.closest('.history-section')) {
                viewBtn = document.createElement('button');
                viewBtn.className = 'view-history-btn';
                viewBtn.textContent = 'ğŸ“Š æŸ¥çœ‹å†å²è®°å½•';
                viewBtn.onclick = toggleHistory;
                viewBtn.style.marginTop = '20px';
                viewBtn.style.marginBottom = '10px';
                document.querySelector('.message-container').appendChild(viewBtn);
            }

            // æ·»åŠ æ—¥è®°å’ŒéŸ³ä¹æŒ‰é’®
            const actionButtons = document.createElement('div');
            actionButtons.style.display = 'flex';
            actionButtons.style.gap = '10px';
            actionButtons.style.marginTop = '15px';
            actionButtons.style.justifyContent = 'center';
            actionButtons.style.flexWrap = 'wrap';
            
            const diaryBtn = document.createElement('button');
            diaryBtn.className = 'view-history-btn';
            diaryBtn.textContent = 'ğŸ“ å†™æ—¥è®°';
            diaryBtn.onclick = showDiarySection;
            actionButtons.appendChild(diaryBtn);

            const musicBtn = document.createElement('button');
            musicBtn.className = 'view-history-btn';
            musicBtn.textContent = 'ğŸµ éŸ³ä¹æ¨è';
            musicBtn.onclick = () => {
                const currentMood = Storage.getCurrentMood();
                if (!currentMood) {
                    const messageElement = document.getElementById('message');
                    messageElement.classList.remove('show');
                    setTimeout(() => {
                        messageElement.textContent = 'ğŸ’¡ å…ˆé€‰æ‹©ä¸€ä¸‹ä»Šå¤©çš„å¿ƒæƒ…ï¼Œæˆ‘å†ä¸ºä½ æ¨èåˆé€‚çš„éŸ³ä¹ï½';
                        messageElement.classList.add('show');
                    }, 50);
                    return;
                }
                showMusicRecommendations(currentMood);
            };
            actionButtons.appendChild(musicBtn);

            document.querySelector('.message-container').appendChild(actionButtons);
        });
    </script>

    <script>
        const moodButtons = document.querySelectorAll('.mood-btn');
        const messageElement = document.getElementById('message');
        const moodSelection = document.getElementById('moodSelection');
        const reasonSelection = document.getElementById('reasonSelection');
        const reasonButtons = document.querySelectorAll('.reason-btn');
        const backToMoodBtn = document.getElementById('backToMood');
        
        // ä¸åŒå¿ƒæƒ…å¯¹åº”çš„é¼“åŠ±è¯è¯­ï¼ˆå·²æ‰©å……ï¼‰
        const messages = {
            happy: [
                'ğŸŒŸ å¤ªæ£’äº†ï¼ä¿æŒè¿™ä»½å¥½å¿ƒæƒ…ï¼Œè®©å¿«ä¹å»¶ç»­ä¸€æ•´å¤©ï¼',
                'ğŸ’« ä½ çš„ç¬‘å®¹æ˜¯æœ€ç¾çš„é£æ™¯ï¼Œç»§ç»­ä¿æŒå“¦ï½',
                'âœ¨ å¼€å¿ƒæ˜¯æœ€å¥½çš„è‰¯è¯ï¼Œæ„¿ä½ çš„æ¯ä¸€å¤©éƒ½å……æ»¡é˜³å…‰ï¼',
                'ğŸ‰ çœ‹åˆ°ä½ è¿™ä¹ˆå¼€å¿ƒï¼Œä¸–ç•Œéƒ½å˜å¾—æ›´ç¾å¥½äº†å‘¢ï¼',
                'ğŸŒ å¿«ä¹æ˜¯ä¼šä¼ æŸ“çš„ï¼Œä½ çš„å¥½å¿ƒæƒ…ä¼šè®©å‘¨å›´çš„äººéƒ½æ„Ÿåˆ°æ¸©æš–ï¼',
                'ğŸ’ ä¿æŒè¿™ä»½ç§¯æçš„å¿ƒæ€ï¼Œå¥½äº‹ä¼šæ¥è¸µè€Œæ¥çš„ï½',
                'ğŸˆ ä»Šå¤©æ˜¯ä¸ªå¥½æ—¥å­ï¼Œå¥½å¥½äº«å—è¿™ä»½å¿«ä¹å§ï¼',
                'ğŸŒˆ ä½ çš„æ­£èƒ½é‡å°±åƒå½©è™¹ä¸€æ ·ç¾ä¸½ï¼Œç»§ç»­å‘å…‰å‘çƒ­ï¼',
                'ğŸŒ¸ å¼€å¿ƒçš„æ—¶å€™ï¼Œè®°å¾—æŠŠè¿™ä»½ç¾å¥½åˆ†äº«ç»™èº«è¾¹çš„äººå“¦',
                'ğŸ’ çœ‹åˆ°ä½ å¼€å¿ƒï¼Œæˆ‘ä¹Ÿä¸ºä½ æ„Ÿåˆ°é«˜å…´ï¼ç»§ç»­ä¿æŒï½',
                'ğŸŠ å¿«ä¹æ˜¯ç”Ÿæ´»æœ€å¥½çš„è°ƒå‘³å‰‚ï¼Œæ„¿ä½ æ¯å¤©éƒ½è¿™ä¹ˆå¼€å¿ƒï¼',
                'ğŸŒ» åƒå‘æ—¥è‘µä¸€æ ·ï¼Œæ°¸è¿œé¢å‘é˜³å…‰ï¼Œä¿æŒå¾®ç¬‘ï¼',
                'â­ ä½ çš„å¿«ä¹å°±æ˜¯æœ€äº®çš„æ˜Ÿï¼Œç…§äº®è‡ªå·±ï¼Œä¹Ÿæ¸©æš–ä»–äºº',
                'ğŸ æ¯ä¸€å¤©éƒ½æ˜¯ç¤¼ç‰©ï¼Œå¼€å¿ƒåœ°æ‰“å¼€å®ƒå§ï¼',
                'ğŸ’– ä¿æŒè¿™ä»½å¥½å¿ƒæƒ…ï¼Œè®©æ¯ä¸€å¤©éƒ½å……æ»¡å¸Œæœ›å’Œå¿«ä¹ï¼'
            ],
            neutral: [
                'ğŸŒ¤ï¸ å¹³æ·¡ä¹Ÿæ˜¯ä¸€ç§ç¾å¥½ï¼Œäº«å—å½“ä¸‹çš„å®é™å§ï½',
                'ğŸ’­ æœ‰æ—¶å€™ï¼Œå¹³é™çš„å¿ƒå¢ƒå°±æ˜¯æœ€å¥½çš„çŠ¶æ€',
                'ğŸŒ¸ å¹³å‡¡çš„æ—¥å­é‡Œä¹Ÿæœ‰å°ç¡®å¹¸ï¼Œæ…¢æ…¢æ„Ÿå—ç”Ÿæ´»çš„ç¾å¥½',
                'â˜ï¸ ä¸æ‚²ä¸å–œï¼Œä¿æŒå†…å¿ƒçš„å¹³è¡¡ï¼Œè¿™å°±æ˜¯æ™ºæ…§',
                'ğŸŒ¿ å¹³é™å¦‚æ°´çš„å¿ƒå¢ƒï¼Œä¹Ÿæ˜¯ä¸€ç§éš¾å¾—çš„å¹¸ç¦',
                'ğŸƒ å¹³æ·¡çš„æ—¥å­é‡Œï¼Œè—ç€ç”Ÿæ´»çš„çœŸè°›',
                'ğŸŒ™ ä¸éª„ä¸èºï¼Œä¿æŒå†…å¿ƒçš„å¹³å’Œï¼Œè¿™å°±æ˜¯æœ€å¥½çš„çŠ¶æ€',
                'ğŸ’§ å¹³é™çš„å¿ƒæ¹–ï¼Œèƒ½æ˜ ç…§å‡ºæœ€ç¾çš„é£æ™¯',
                'ğŸŒ¾ å¹³å‡¡çš„æ—¥å­ï¼Œä¹Ÿæœ‰å®ƒç‹¬ç‰¹çš„éŸµå‘³',
                'ğŸ•Šï¸ å†…å¿ƒçš„å¹³é™ï¼Œæ˜¯æœ€å¤§çš„è´¢å¯Œ',
                'ğŸŒŠ åƒå¤§æµ·ä¸€æ ·ï¼Œè¡¨é¢å¹³é™ï¼Œå†…å¿ƒæ·±é‚ƒ',
                'ğŸµ å¹³æ·¡å¦‚èŒ¶ï¼Œç»†ç»†å“å‘³ï¼Œè‡ªæœ‰ç”˜ç”œ',
                'ğŸŒŒ å¹³é™çš„å¤œæ™šï¼Œä¹Ÿæœ‰æ˜Ÿæ˜Ÿåœ¨é—ªçƒ',
                'ğŸ‹ å¹³å‡¡çš„ç”Ÿæ´»ï¼Œä¹Ÿèƒ½å¼€å‡ºç¾ä¸½çš„èŠ±',
                'ğŸ§˜ ä¿æŒå†…å¿ƒçš„å¹³è¡¡ï¼Œå°±æ˜¯æœ€å¥½çš„ä¿®è¡Œ'
            ],
            sad: [
                'ğŸ’™ éš¾è¿‡çš„æ—¶å€™ï¼Œè®°å¾—ç»™è‡ªå·±ä¸€ä¸ªæ¸©æš–çš„æ‹¥æŠ±',
                'ğŸŒˆ é£é›¨è¿‡åæ€»ä¼šæœ‰å½©è™¹ï¼Œç›¸ä¿¡æ˜å¤©ä¼šæ›´å¥½',
                'ğŸ¤— æ¯ä¸ªäººéƒ½ä¼šæœ‰ä½è°·ï¼Œä½†ä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨æˆ˜æ–—',
                'ğŸŒ™ éš¾è¿‡æ˜¯æš‚æ—¶çš„ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´åšå¼ºï¼ŒåŠ æ²¹ï¼',
                'ğŸ’œ ä½ çš„æ„Ÿå—æ˜¯çœŸå®çš„ï¼Œä¹Ÿæ˜¯é‡è¦çš„ï¼Œå…è®¸è‡ªå·±éš¾è¿‡',
                'ğŸ¦‹ å°±åƒè´è¶ç ´èŒ§ï¼Œç—›è‹¦ä¹‹åæ˜¯ç¾ä¸½çš„èœ•å˜',
                'ğŸŒ± ä½è°·æ˜¯æˆé•¿çš„åœŸå£¤ï¼Œä½ ä¼šå˜å¾—æ›´å¼ºå¤§',
                'ğŸ’ª éš¾è¿‡ä¸ä¼šæ°¸è¿œæŒç»­ï¼Œä½ æ¯”æƒ³è±¡ä¸­æ›´åšéŸ§',
                'ğŸ¤ è®°å¾—ï¼Œä½ å¹¶ä¸å­¤å•ï¼Œæœ‰äººåœ¨ä¹ä½ ï¼Œå…³å¿ƒä½ ',
                'ğŸŒ… å³ä½¿æ˜¯æœ€é»‘æš—çš„å¤œæ™šï¼Œé»æ˜ä¹Ÿä¼šåˆ°æ¥',
                'ğŸ’ ç»™è‡ªå·±ä¸€äº›æ—¶é—´ï¼Œæ…¢æ…¢ç–—æ„ˆï¼Œæ…¢æ…¢æ¢å¤',
                'ğŸ­ éš¾è¿‡æ˜¯æƒ…ç»ªçš„ä¸€éƒ¨åˆ†ï¼Œæ¥å—å®ƒï¼Œç„¶åç»§ç»­å‰è¡Œ',
                'ğŸŒŠ å°±åƒæµ·æµªï¼Œæœ‰èµ·æœ‰è½ï¼Œä½†å¤§æµ·ä¾ç„¶åœ¨é‚£é‡Œ',
                'ğŸ•¯ï¸ å³ä½¿åœ¨é»‘æš—ä¸­ï¼Œä¹Ÿè¦ç›¸ä¿¡å…‰æ˜çš„å­˜åœ¨',
                'ğŸ’š ä½ çš„ä»·å€¼ä¸ä¼šå› ä¸ºä¸€æ—¶çš„éš¾è¿‡è€Œå‡å°‘ï¼Œä½ ä¾ç„¶å¾ˆæ£’'
            ]
        };

        // ä¸åŒåŸå› å¯¹åº”çš„å¼€å¯¼è¯­è¨€
        const reasonMessages = {
            work: [
                'ğŸ’¼ å·¥ä½œå‹åŠ›ç¡®å®è®©äººç–²æƒ«ï¼Œä½†ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ã€‚è®°ä½ï¼Œå·¥ä½œåªæ˜¯ç”Ÿæ´»çš„ä¸€éƒ¨åˆ†ï¼Œä¸è¦è®©å®ƒå‹å®ä½ ã€‚é€‚å½“ä¼‘æ¯ï¼Œè°ƒæ•´èŠ‚å¥ï¼Œä½ ä¼šæ‰¾åˆ°å¹³è¡¡çš„ã€‚',
                'ğŸ’¼ å‹åŠ›æ˜¯æˆé•¿çš„å‚¬åŒ–å‰‚ï¼Œä½†ä¹Ÿè¦è®°å¾—ç»™è‡ªå·±å–˜æ¯çš„ç©ºé—´ã€‚ä»Šå¤©ç´¯äº†å°±å¥½å¥½ä¼‘æ¯ï¼Œæ˜å¤©åˆæ˜¯æ–°çš„ä¸€å¤©ã€‚ä½ æ¯”æƒ³è±¡ä¸­æ›´å¼ºå¤§ï¼',
                'ğŸ’¼ å·¥ä½œä¸Šçš„å›°éš¾éƒ½æ˜¯æš‚æ—¶çš„ï¼Œä½ å·²ç»å…‹æœäº†é‚£ä¹ˆå¤šæŒ‘æˆ˜ï¼Œè¿™æ¬¡ä¹Ÿä¸€å®šå¯ä»¥ã€‚ç»™è‡ªå·±ä¸€äº›è€å¿ƒå’Œé¼“åŠ±ï¼Œæ…¢æ…¢æ¥ï¼Œä¸ç€æ€¥ã€‚'
            ],
            relationship: [
                'ğŸ‘¥ äººé™…å…³ç³»ç¡®å®å¤æ‚ï¼Œä½†è®°ä½ï¼šçœŸæ­£åœ¨ä¹ä½ çš„äººä¼šç†è§£ä½ ã€‚å¦‚æœæœ‰äº›å…³ç³»è®©ä½ æ„Ÿåˆ°ç–²æƒ«ï¼Œé€‚å½“ä¿æŒè·ç¦»ä¹Ÿæ˜¯æ˜æ™ºçš„é€‰æ‹©ã€‚',
                'ğŸ‘¥ æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„èŠ‚å¥å’Œæ–¹å¼ï¼Œä¸å¿…å¼ºæ±‚æ‰€æœ‰äººéƒ½ç†è§£ä½ ã€‚åšçœŸå®çš„è‡ªå·±ï¼Œå¸å¼•é‚£äº›çœŸæ­£æ¬£èµä½ çš„äººã€‚',
                'ğŸ‘¥ å…³ç³»éœ€è¦æ—¶é—´ç£¨åˆï¼Œä¹Ÿéœ€è¦åŒæ–¹çš„åŠªåŠ›ã€‚å¦‚æœæ„Ÿåˆ°å›°æ‰°ï¼Œè¯•ç€æ²Ÿé€šï¼Œæˆ–è€…ç»™è‡ªå·±ä¸€äº›ç©ºé—´ã€‚ä½ å€¼å¾—è¢«æ¸©æŸ”å¯¹å¾…ã€‚'
            ],
            emotion: [
                'ğŸ’” æƒ…æ„Ÿä¸Šçš„ä¼¤ç—›éœ€è¦æ—¶é—´æ¥æ²»æ„ˆï¼Œè¿™æ˜¯å®Œå…¨æ­£å¸¸çš„ã€‚å…è®¸è‡ªå·±æ„Ÿå—è¿™äº›æƒ…ç»ªï¼Œä½†ä¹Ÿè¦ç›¸ä¿¡ï¼Œæ—¶é—´ä¼šå¸¦æ¥æ–°çš„å¸Œæœ›å’Œç¾å¥½ã€‚',
                'ğŸ’” å¿ƒç¢çš„æ„Ÿè§‰å¾ˆç—›ï¼Œä½†è¿™ä¹Ÿè¯æ˜ä½ æ›¾ç»çœŸè¯šåœ°ä»˜å‡ºè¿‡ã€‚ç»™è‡ªå·±æ—¶é—´ï¼Œæ…¢æ…¢ç–—æ„ˆï¼Œä½ ä¼šé‡æ–°æ‰¾åˆ°å±äºè‡ªå·±çš„å¹¸ç¦ã€‚',
                'ğŸ’” æƒ…æ„Ÿè·¯ä¸Šçš„æŒ«æŠ˜æ˜¯æˆé•¿çš„ä¸€éƒ¨åˆ†ã€‚è®°ä½ï¼Œä½ çš„ä»·å€¼ä¸å–å†³äºä»»ä½•äººçš„è®¤å¯ã€‚ä½ å€¼å¾—è¢«çˆ±ï¼Œä¹Ÿå€¼å¾—æ‹¥æœ‰ç¾å¥½çš„æœªæ¥ã€‚'
            ],
            health: [
                'ğŸ¥ å¥åº·é—®é¢˜ç¡®å®è®©äººæ‹…å¿ƒï¼Œä½†ç°ä»£åŒ»å­¦å¾ˆå‘è¾¾ï¼Œç§¯æé…åˆæ²»ç–—ï¼Œä¿æŒä¹è§‚å¿ƒæ€ï¼Œä¸€åˆ‡éƒ½ä¼šå¥½èµ·æ¥çš„ã€‚è®°å¾—è¦å¥½å¥½ç…§é¡¾è‡ªå·±ã€‚',
                'ğŸ¥ èº«ä½“æ˜¯é©å‘½çš„æœ¬é’±ï¼Œå¥åº·é—®é¢˜éœ€è¦é‡è§†ä½†ä¸è¦è¿‡åº¦ç„¦è™‘ã€‚å¬ä»åŒ»ç”Ÿçš„å»ºè®®ï¼Œä¿æŒè§„å¾‹ä½œæ¯ï¼Œä½ ä¼šæ…¢æ…¢æ¢å¤çš„ã€‚',
                'ğŸ¥ å¥åº·é—®é¢˜è™½ç„¶è®©äººå›°æ‰°ï¼Œä½†ä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨é¢å¯¹ã€‚å¯»æ±‚ä¸“ä¸šå¸®åŠ©ï¼Œä¿æŒç§¯æå¿ƒæ€ï¼Œç›¸ä¿¡ä¸€åˆ‡éƒ½ä¼šå¥½è½¬çš„ã€‚'
            ],
            study: [
                'ğŸ“š å­¦ä¹ å‹åŠ›ç¡®å®å¾ˆå¤§ï¼Œä½†è®°ä½ï¼šè¿›æ­¥æ˜¯ä¸€æ­¥æ­¥æ¥çš„ï¼Œä¸è¦å¯¹è‡ªå·±å¤ªè‹›åˆ»ã€‚åˆ¶å®šåˆç†çš„ç›®æ ‡ï¼ŒæŒ‰è‡ªå·±çš„èŠ‚å¥å‰è¿›å°±å¥½ã€‚',
                'ğŸ“š å­¦ä¹ è·¯ä¸Šçš„å›°éš¾éƒ½æ˜¯æš‚æ—¶çš„ï¼Œä½ å·²ç»èµ°äº†è¿™ä¹ˆè¿œï¼Œè¯´æ˜ä½ æœ‰èƒ½åŠ›å…‹æœæŒ‘æˆ˜ã€‚é€‚å½“ä¼‘æ¯ï¼Œè°ƒæ•´æ–¹æ³•ï¼Œä½ ä¼šæ‰¾åˆ°é€‚åˆè‡ªå·±çš„å­¦ä¹ æ–¹å¼ã€‚',
                'ğŸ“š å‹åŠ›æ˜¯å­¦ä¹ è·¯ä¸Šçš„å¸¸å®¢ï¼Œä½†ä¸è¦è®©å®ƒä»¬å‹å®ä½ ã€‚è®°ä½ï¼Œå­¦ä¹ æ˜¯ä¸ºäº†æˆé•¿ï¼Œä¸æ˜¯ä¸ºäº†å®Œç¾ã€‚ç»™è‡ªå·±ä¸€äº›é¼“åŠ±ï¼Œä½ å·²ç»å¾ˆæ£’äº†ï¼'
            ],
            other: [
                'ğŸ’­ æ— è®ºæ˜¯ä»€ä¹ˆåŸå› è®©ä½ éš¾è¿‡ï¼Œéƒ½è¯·è®°ä½ï¼šä½ çš„æ„Ÿå—æ˜¯çœŸå®çš„ï¼Œä¹Ÿæ˜¯é‡è¦çš„ã€‚ç»™è‡ªå·±ä¸€äº›æ—¶é—´å’Œç©ºé—´ï¼Œæ…¢æ…¢å¤„ç†è¿™äº›æƒ…ç»ªã€‚',
                'ğŸ’­ ç”Ÿæ´»ä¸­çš„å›°éš¾æ€»æ˜¯ä¼šæœ‰çš„ï¼Œä½†ä½ æœ‰èƒ½åŠ›é¢å¯¹å®ƒä»¬ã€‚ä¸è¦ç‹¬è‡ªæ‰¿å—ï¼Œå¯ä»¥æ‰¾ä¿¡ä»»çš„äººèŠèŠï¼Œæˆ–è€…ç»™è‡ªå·±ä¸€äº›æ—¶é—´æ…¢æ…¢æ¶ˆåŒ–ã€‚',
                'ğŸ’­ éš¾è¿‡çš„æ—¶å€™ï¼Œè®°å¾—è¦å–„å¾…è‡ªå·±ã€‚å…è®¸è‡ªå·±æ„Ÿå—è¿™äº›æƒ…ç»ªï¼Œä½†ä¹Ÿè¦ç›¸ä¿¡ï¼Œå›°éš¾æ˜¯æš‚æ—¶çš„ï¼Œä½ ä¼šæ‰¾åˆ°è§£å†³çš„åŠæ³•çš„ã€‚'
            ]
        };

        // å¿ƒæƒ…æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        moodButtons.forEach(button => {
            button.addEventListener('click', function() {
                const mood = this.getAttribute('data-mood');
                
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                moodButtons.forEach(btn => btn.classList.remove('selected'));
                
                // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰æŒ‰é’®
                this.classList.add('selected');
                
                // å¦‚æœé€‰æ‹©çš„æ˜¯éš¾è¿‡ï¼Œæ˜¾ç¤ºåŸå› é€‰æ‹©ç•Œé¢
                if (mood === 'sad') {
                    moodSelection.classList.add('hidden');
                    reasonSelection.classList.add('show');
                    messageElement.classList.remove('show');
                    messageElement.textContent = '';
                } else {
                    // å…¶ä»–å¿ƒæƒ…ç›´æ¥æ˜¾ç¤ºé¼“åŠ±è¯è¯­
                    handleMoodSelection(mood, null);
                }
            });
        });

        // å¤„ç†å¿ƒæƒ…é€‰æ‹©ï¼ˆä¿å­˜è®°å½•ã€æ›´æ–°æ‰“å¡ã€æ˜¾ç¤ºæ¶ˆæ¯ï¼‰
        function handleMoodSelection(mood, reason) {
            // ä¿å­˜å¿ƒæƒ…è®°å½•
            saveMoodRecord(mood, reason);
            
            // ä¿å­˜å½“å‰å¿ƒæƒ…ï¼ˆç”¨äºæ—¥è®°å’ŒéŸ³ä¹æ¨èï¼‰
            Storage.setCurrentMood(mood);
            
            // æ›´æ–°æ‰“å¡å¤©æ•°
            const newStreak = updateStreak();
            
            // æ›´æ–°æ‰“å¡æé†’
            showCheckinReminder();
            
            // ç¡®ä¿å†å²è®°å½•æŒ‰é’®å­˜åœ¨
            ensureHistoryButton();
            
            // æ˜¾ç¤ºé¼“åŠ±è¯è¯­
            const moodMessages = messages[mood];
            const randomMessage = moodMessages[Math.floor(Math.random() * moodMessages.length)];
            
            messageElement.classList.remove('show');
            setTimeout(() => {
                messageElement.textContent = randomMessage;
                messageElement.classList.add('show');
            }, 50);

            // è‡ªåŠ¨æ˜¾ç¤ºéŸ³ä¹æ¨è
            setTimeout(() => {
                showMusicRecommendations(mood);
            }, 800);

            // å¦‚æœæœ‰å†å²è®°å½•åŒºåŸŸï¼Œæ›´æ–°å›¾è¡¨
            const historySection = document.getElementById('historySection');
            if (historySection && historySection.style.display !== 'none') {
                renderHistoryChart();
            }
        }

        // ç¡®ä¿å†å²è®°å½•æŒ‰é’®å­˜åœ¨
        function ensureHistoryButton() {
            let viewBtn = document.querySelector('.view-history-btn');
            if (!viewBtn || viewBtn.closest('.history-section')) {
                viewBtn = document.createElement('button');
                viewBtn.className = 'view-history-btn';
                viewBtn.textContent = 'ğŸ“Š æŸ¥çœ‹å†å²è®°å½•';
                viewBtn.onclick = toggleHistory;
                viewBtn.style.marginTop = '20px';
                viewBtn.style.marginBottom = '10px';
                document.querySelector('.message-container').appendChild(viewBtn);
            }
        }

        // ========== æƒ…æ„Ÿé™ªä¼´å°åŠ©æ‰‹ (AIèŠå¤©ç‰ˆ) ==========
        const Assistant = {
            messages: {
                morning: [
                    'ğŸŒ… æ—©ä¸Šå¥½ï¼æ–°çš„ä¸€å¤©å¼€å§‹äº†ï¼Œå¸Œæœ›ä½ ä»Šå¤©å¿ƒæƒ…æ„‰å¿«ï½',
                    'â˜€ï¸ æ—©å®‰ï¼è®°å¾—ç»™è‡ªå·±ä¸€ä¸ªå¾®ç¬‘ï¼Œä»Šå¤©ä¼šæ˜¯ç¾å¥½çš„ä¸€å¤©ï¼',
                    'ğŸŒ æ—©ä¸Šå¥½ï¼æ— è®ºä»Šå¤©é‡åˆ°ä»€ä¹ˆï¼Œéƒ½è¦ä¿æŒå¥½å¿ƒæƒ…å“¦ï½'
                ],
                afternoon: [
                    'ğŸŒ¤ï¸ ä¸‹åˆå¥½ï¼ä»Šå¤©è¿‡å¾—æ€ä¹ˆæ ·ï¼Ÿè®°å¾—é€‚å½“ä¼‘æ¯ä¸€ä¸‹ï½',
                    'â˜• ä¸‹åˆæ—¶å…‰ï¼Œæ¥æ¯èŒ¶ï¼Œæ”¾æ¾ä¸€ä¸‹å¿ƒæƒ…å§ï½',
                    'ğŸ’¼ ä¸‹åˆå¥½ï¼å·¥ä½œå­¦ä¹ ä¹‹ä½™ï¼Œåˆ«å¿˜äº†ç…§é¡¾å¥½è‡ªå·±çš„å¿ƒæƒ…ï½'
                ],
                evening: [
                    'ğŸŒ™ æ™šä¸Šå¥½ï¼ä»Šå¤©è¾›è‹¦äº†ï¼Œå¥½å¥½æ”¾æ¾ä¸€ä¸‹å§ï½',
                    'â­ å¤œæ™šæ¥ä¸´ï¼Œå›é¡¾ä»Šå¤©ï¼Œè®°å¾—ç»™è‡ªå·±ä¸€äº›é¼“åŠ±ï½',
                    'ğŸŒƒ æ™šä¸Šå¥½ï¼ä»Šå¤©çš„å¿ƒæƒ…å¦‚ä½•ï¼Ÿæœ‰ä»€ä¹ˆæƒ³åˆ†äº«çš„å—ï¼Ÿ'
                ],
                general: [
                    'ğŸ’™ æˆ‘åœ¨è¿™é‡Œé™ªä¼´ä½ ï¼Œæ— è®ºå¼€å¿ƒè¿˜æ˜¯éš¾è¿‡ï½',
                    'ğŸ¤— è®°å¾—ï¼Œä½ çš„æ„Ÿå—å¾ˆé‡è¦ï¼Œæˆ‘ç†è§£ä½ ï½',
                    'ğŸŒˆ ç”Ÿæ´»æœ‰èµ·æœ‰è½ï¼Œä½†ä½ ä¸æ˜¯ä¸€ä¸ªäººåœ¨é¢å¯¹ï½',
                    'ğŸ’ª ä½ å·²ç»åšå¾—å¾ˆå¥½äº†ï¼Œç»§ç»­ä¿æŒï½',
                    'ğŸŒ¸ æ¯ä¸€å¤©éƒ½æ˜¯æ–°çš„å¼€å§‹ï¼ŒåŠ æ²¹ï¼'
                ]
            },

            getGreeting: () => {
                const hour = new Date().getHours();
                let timeOfDay;
                if (hour >= 6 && hour < 12) {
                    timeOfDay = 'morning';
                } else if (hour >= 12 && hour < 18) {
                    timeOfDay = 'afternoon';
                } else {
                    timeOfDay = 'evening';
                }
                const greetings = Assistant.messages[timeOfDay];
                return greetings[Math.floor(Math.random() * greetings.length)];
            },

            chatHistory: [],

            getApiConfig: () => {
                const config = localStorage.getItem('aiApiConfig');
                return config ? JSON.parse(config) : {
                    provider: 'huggingface',
                    ollama: { url: 'http://localhost:11434/api/chat', model: 'llama3.2' },
                    huggingface: { apiKey: '', model: 'meta-llama/Llama-3.2-3B-Instruct' },
                    groq: { apiKey: '', model: 'llama-3.1-8b-instant' },
                    openai: { apiKey: '', model: 'gpt-3.5-turbo' }
                };
            },

            saveApiConfig: (config) => {
                localStorage.setItem('aiApiConfig', JSON.stringify(config));
            },

            getSystemPrompt: () => {
                const currentMood = Storage.getCurrentMood();
                const moodText = currentMood === 'happy' ? 'å¼€å¿ƒ' : currentMood === 'neutral' ? 'ä¸€èˆ¬' : currentMood === 'sad' ? 'éš¾è¿‡' : 'æœªçŸ¥';
                return `ä½ æ˜¯ä¸€ä¸ªæ¸©æš–ã€è´´å¿ƒçš„æƒ…æ„Ÿé™ªä¼´åŠ©æ‰‹ã€‚ç”¨æˆ·å½“å‰å¿ƒæƒ…æ˜¯${moodText}ã€‚è¯·ç”¨æ¸©æš–ã€ç†è§£ã€æ”¯æŒçš„è¯­æ°”ä¸ç”¨æˆ·å¯¹è¯ï¼Œå¸®åŠ©ç”¨æˆ·è¡¨è¾¾æƒ…æ„Ÿã€ç¼“è§£å‹åŠ›ã€æä¾›å»ºè®®ã€‚ä¿æŒç®€æ´ã€è‡ªç„¶çš„å¯¹è¯é£æ ¼ï¼Œæ¯æ¬¡å›å¤æ§åˆ¶åœ¨100å­—ä»¥å†…ã€‚`;
            },

            async callAI(message) {
                const config = Assistant.getApiConfig();
                const systemPrompt = Assistant.getSystemPrompt();

                try {
                    switch (config.provider) {
                        case 'ollama':
                            return await Assistant.callOllama(message, systemPrompt, config.ollama);
                        case 'huggingface':
                            return await Assistant.callHuggingFace(message, systemPrompt, config.huggingface);
                        case 'groq':
                            return await Assistant.callGroq(message, systemPrompt, config.groq);
                        case 'openai':
                            return await Assistant.callOpenAI(message, systemPrompt, config.openai);
                        default:
                            throw new Error('æœªé…ç½®AIæ¨¡å‹');
                    }
                } catch (error) {
                    console.error('AIè°ƒç”¨é”™è¯¯:', error);
                    throw error;
                }
            },

            async callOllama(message, systemPrompt, config) {
                const response = await fetch(config.url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...Assistant.chatHistory.slice(-10),
                            { role: 'user', content: message }
                        ],
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`Ollama APIé”™è¯¯: ${response.statusText}`);
                }

                const data = await response.json();
                return data.message.content;
            },

            async callHuggingFace(message, systemPrompt, config) {
                // ä¼˜å…ˆä½¿ç”¨Netlify Functionä»£ç†ï¼ˆæ‰€æœ‰ç”¨æˆ·æ— éœ€é…ç½®API Keyï¼‰
                try {
                    const functionUrl = '/.netlify/functions/huggingface-proxy';
                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [
                                ...Assistant.chatHistory.slice(-10).map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                })),
                                { role: 'user', content: message }
                            ],
                            systemPrompt: systemPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            errorData = { error: errorText };
                        }
                        
                        // å¦‚æœä»£ç†æœªé…ç½®ï¼ˆ404æˆ–500ï¼‰ï¼Œå›é€€åˆ°ç›´æ¥è°ƒç”¨ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†API Keyï¼‰
                        if (response.status === 404 || (response.status === 500 && (errorData.error && errorData.error.includes('not configured')))) {
                            if (config.apiKey && config.apiKey.trim()) {
                                console.log('ä»£ç†æœªé…ç½®ï¼Œä½¿ç”¨ç›´æ¥è°ƒç”¨æ¨¡å¼');
                                return await this.callHuggingFaceDirect(message, systemPrompt, config);
                            }
                            throw new Error('PROXY_NOT_CONFIGURED');
                        }
                        throw new Error(`ä»£ç†æœåŠ¡é”™è¯¯: ${errorData.error || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.content;
                } catch (error) {
                    // å¦‚æœä»£ç†å¤±è´¥ï¼ˆ404æˆ–ç½‘ç»œé”™è¯¯ï¼‰ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†API Keyä½œä¸ºå¤‡ç”¨ï¼‰
                    if ((error.message === 'PROXY_NOT_CONFIGURED' || error.message.includes('Failed to fetch') || error.message.includes('404')) && config.apiKey && config.apiKey.trim()) {
                        try {
                            console.log('ä»£ç†ä¸å¯ç”¨ï¼Œä½¿ç”¨ç›´æ¥è°ƒç”¨æ¨¡å¼:', error.message);
                            return await this.callHuggingFaceDirect(message, systemPrompt, config);
                        } catch (directError) {
                            // å¦‚æœç›´æ¥è°ƒç”¨ä¹Ÿå¤±è´¥ï¼ŒæŠ›å‡ºåŸå§‹é”™è¯¯
                            throw error;
                        }
                    }
                    
                    // å¦‚æœä»£ç†å¤±è´¥ä¸”æ²¡æœ‰API Keyï¼ŒæŠ›å‡ºå‹å¥½é”™è¯¯
                    if (error.message === 'PROXY_NOT_CONFIGURED' || error.message.includes('Failed to fetch') || error.message.includes('404')) {
                        throw new Error('PROXY_NOT_CONFIGURED');
                    }
                    throw error;
                }
            },

            async callHuggingFaceDirect(message, systemPrompt, config) {
                if (!config.apiKey) {
                    throw new Error('è¯·é…ç½®Hugging Face API Key');
                }

                const response = await fetch(`https://api-inference.huggingface.co/models/${config.model}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        inputs: `${systemPrompt}\n\nç”¨æˆ·: ${message}\nåŠ©æ‰‹:`,
                        parameters: {
                            max_new_tokens: 150,
                            temperature: 0.7
                        }
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let errorMessage = `Hugging Face APIé”™è¯¯ (${response.status}): `;
                    
                    try {
                        const errorData = JSON.parse(errorText);
                        errorMessage += errorData.error || errorText;
                    } catch {
                        errorMessage += errorText || response.statusText;
                    }
                    
                    // æ ¹æ®çŠ¶æ€ç æä¾›æ›´å…·ä½“çš„é”™è¯¯ä¿¡æ¯
                    if (response.status === 401 || response.status === 403) {
                        errorMessage += '\n\nğŸ’¡ Tokenå¯èƒ½æ— æ•ˆæˆ–å·²è¿‡æœŸï¼Œè¯·æ£€æŸ¥ï¼š\n1. Tokenæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä»¥hf_å¼€å¤´ï¼‰\n2. Tokenæ˜¯å¦å·²è¿‡æœŸ\n3. Tokenæƒé™æ˜¯å¦è¶³å¤Ÿï¼ˆéœ€è¦readæƒé™ï¼‰';
                    } else if (response.status === 503) {
                        errorMessage += '\n\nğŸ’¡ æ¨¡å‹å¯èƒ½æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨åé‡è¯•';
                    }
                    
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                
                // å¤„ç†Hugging Faceè¿”å›çš„ä¸åŒæ ¼å¼
                let generatedText = '';
                if (Array.isArray(data)) {
                    generatedText = data[0]?.generated_text || '';
                } else if (data.generated_text) {
                    generatedText = data.generated_text;
                } else if (typeof data === 'string') {
                    generatedText = data;
                }
                
                // æå–åŠ©æ‰‹å›å¤
                if (generatedText.includes('åŠ©æ‰‹:')) {
                    generatedText = generatedText.split('åŠ©æ‰‹:').pop().trim();
                }
                
                return generatedText || 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•ç†è§£ï¼Œèƒ½å†è¯´ä¸€éå—ï¼Ÿ';
            },

            async callGroq(message, systemPrompt, config) {
                // ä¼˜å…ˆä½¿ç”¨Netlify Functionä»£ç†ï¼ˆæ— éœ€ç”¨æˆ·é…ç½®API Keyï¼‰
                try {
                    const functionUrl = '/.netlify/functions/groq-proxy';
                    const response = await fetch(functionUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            messages: [
                                ...Assistant.chatHistory.slice(-10).map(msg => ({
                                    role: msg.role,
                                    content: msg.content
                                })),
                                { role: 'user', content: message }
                            ],
                            systemPrompt: systemPrompt
                        })
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        let errorData;
                        try {
                            errorData = JSON.parse(errorText);
                        } catch {
                            errorData = { error: errorText };
                        }
                        
                        // å¦‚æœä»£ç†æœªé…ç½®ï¼Œå›é€€åˆ°ç›´æ¥è°ƒç”¨ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†API Keyï¼‰
                        if (response.status === 500 && (errorData.error && errorData.error.includes('not configured') || errorText.includes('not configured'))) {
                            if (config.apiKey && config.apiKey.trim()) {
                                console.log('ä»£ç†æœªé…ç½®ï¼Œä½¿ç”¨ç›´æ¥è°ƒç”¨æ¨¡å¼');
                                return await this.callGroqDirect(message, systemPrompt, config);
                            }
                            throw new Error('PROXY_NOT_CONFIGURED');
                        }
                        throw new Error(`ä»£ç†æœåŠ¡é”™è¯¯: ${errorData.error || response.statusText}`);
                    }

                    const data = await response.json();
                    return data.content;
                } catch (error) {
                    // å¦‚æœä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨ï¼ˆå¦‚æœç”¨æˆ·é…ç½®äº†API Keyä½œä¸ºå¤‡ç”¨ï¼‰
                    if (error.message !== 'PROXY_NOT_CONFIGURED' && config.apiKey && config.apiKey.trim()) {
                        try {
                            console.log('ä»£ç†å¤±è´¥ï¼Œå°è¯•ç›´æ¥è°ƒç”¨:', error.message);
                            return await this.callGroqDirect(message, systemPrompt, config);
                        } catch (directError) {
                            // å¦‚æœç›´æ¥è°ƒç”¨ä¹Ÿå¤±è´¥ï¼ŒæŠ›å‡ºåŸå§‹é”™è¯¯
                            throw error;
                        }
                    }
                    
                    // å¦‚æœä»£ç†å¤±è´¥ä¸”æ²¡æœ‰API Keyï¼ŒæŠ›å‡ºå‹å¥½é”™è¯¯
                    if (error.message === 'PROXY_NOT_CONFIGURED' || error.message.includes('Failed to fetch')) {
                        throw new Error('PROXY_NOT_CONFIGURED');
                    }
                    throw error;
                }
            },

            async callGroqDirect(message, systemPrompt, config) {
                if (!config.apiKey) {
                    throw new Error('è¯·é…ç½®Groq API Key');
                }

                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...Assistant.chatHistory.slice(-10),
                            { role: 'user', content: message }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });

                if (!response.ok) {
                    throw new Error(`Groq APIé”™è¯¯: ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            },

            async callOpenAI(message, systemPrompt, config) {
                if (!config.apiKey) {
                    throw new Error('è¯·é…ç½®OpenAI API Key');
                }

                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model: config.model,
                        messages: [
                            { role: 'system', content: systemPrompt },
                            ...Assistant.chatHistory.slice(-10),
                            { role: 'user', content: message }
                        ],
                        temperature: 0.7,
                        max_tokens: 200
                    })
                });

                if (!response.ok) {
                    throw new Error(`OpenAI APIé”™è¯¯: ${response.statusText}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            },

            init: () => {
                // åŠ è½½èŠå¤©å†å²
                const savedHistory = localStorage.getItem('chatHistory');
                if (savedHistory) {
                    Assistant.chatHistory = JSON.parse(savedHistory);
                    // æ¢å¤èŠå¤©è®°å½•åˆ°ç•Œé¢
                    const chatMessages = document.getElementById('chatMessages');
                    if (chatMessages && Assistant.chatHistory.length > 0) {
                        Assistant.chatHistory.forEach(msg => {
                            if (msg.role === 'user' || msg.role === 'assistant') {
                                addMessageToChat(msg.role === 'user' ? 'user' : 'assistant', msg.content, false);
                            }
                        });
                    }
                }
            }
        };

        // èŠå¤©çª—å£æ§åˆ¶
        function toggleChatWindow() {
            const chatWindow = document.getElementById('chatWindow');
            const wasHidden = !chatWindow.classList.contains('show');
            chatWindow.classList.toggle('show');
            
            if (chatWindow.classList.contains('show')) {
                document.getElementById('chatInput').focus();
                
                // é¦–æ¬¡æ‰“å¼€æ—¶ï¼Œæ¬¢è¿æ¶ˆæ¯å·²ç»åŒ…å«äº†ä½¿ç”¨è¯´æ˜
                // é€šè¿‡Gitéƒ¨ç½²åï¼ŒHugging Faceä»£ç†ä¼šè‡ªåŠ¨å¤„ç†API Keyï¼Œç”¨æˆ·æ— éœ€é…ç½®
            }
        }

        function closeChatWindow() {
            document.getElementById('chatWindow').classList.remove('show');
        }

        // å‘é€èŠå¤©æ¶ˆæ¯
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message) return;

            // ç¦ç”¨è¾“å…¥å’ŒæŒ‰é’®
            input.disabled = true;
            document.getElementById('chatSendBtn').disabled = true;

            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessageToChat('user', message);
            input.value = '';

            // æ·»åŠ åˆ°å†å²è®°å½•
            Assistant.chatHistory.push({ role: 'user', content: message });

            // æ˜¾ç¤ºæ‰“å­—æŒ‡ç¤ºå™¨
            showTypingIndicator();

            try {
                // è°ƒç”¨AI
                const response = await Assistant.callAI(message);
                
                // ç§»é™¤æ‰“å­—æŒ‡ç¤ºå™¨
                hideTypingIndicator();

                // æ·»åŠ AIå›å¤
                addMessageToChat('assistant', response);
                
                // æ·»åŠ åˆ°å†å²è®°å½•
                Assistant.chatHistory.push({ role: 'assistant', content: response });

                // ä¿å­˜èŠå¤©å†å²ï¼ˆåªä¿ç•™æœ€è¿‘50æ¡ï¼‰
                Assistant.chatHistory = Assistant.chatHistory.slice(-50);
                localStorage.setItem('chatHistory', JSON.stringify(Assistant.chatHistory));

            } catch (error) {
                hideTypingIndicator();
                let errorMsg = 'æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›å¤ã€‚';
                
                if (error.message === 'PROXY_NOT_CONFIGURED' || error.message.includes('ä»£ç†æœåŠ¡æœªé…ç½®') || error.message.includes('not configured') || error.message.includes('404')) {
                    errorMsg += '\n\nğŸ’¡ éœ€è¦é…ç½®API Keyæ‰èƒ½ä½¿ç”¨AIåŠ©æ‰‹\n\nğŸ“ å¿«é€Ÿé…ç½®ï¼ˆåªéœ€1åˆ†é’Ÿï¼‰ï¼š\n1. ç‚¹å‡»å³ä¸Šè§’âš™ï¸æŒ‰é’®\n2. é€‰æ‹©"ğŸ¤— Hugging Face (åœ¨çº¿)"\n3. ç²˜è´´ä½ çš„Access Tokenï¼ˆæ ¼å¼ï¼šhf_xxxxxï¼‰\n4. ç‚¹å‡»"ğŸ’¾ ä¿å­˜é…ç½®"\n\nğŸ”— è·å–Access Tokenï¼š\nhttps://huggingface.co/settings/tokens\n\nâœ¨ é…ç½®å®Œæˆåå°±å¯ä»¥å¼€å§‹èŠå¤©äº†ï¼';
                    
                    // è‡ªåŠ¨æ‰“å¼€é…ç½®çª—å£
                    setTimeout(() => {
                        showApiConfig();
                        selectedApiOption = 'huggingface';
                        document.querySelectorAll('.api-option').forEach((opt, index) => {
                            const providers = ['ollama', 'huggingface', 'groq', 'openai'];
                            opt.classList.remove('selected');
                            if (providers[index] === 'huggingface') {
                                opt.classList.add('selected');
                            }
                        });
                        // èšç„¦åˆ°API Keyè¾“å…¥æ¡†
                        setTimeout(() => {
                            const apiKeyInput = document.getElementById('hfApiKey');
                            if (apiKeyInput) {
                                apiKeyInput.focus();
                            }
                        }, 300);
                    }, 500);
                } else if (error.message.includes('Failed to fetch') || error.message.includes('Network')) {
                    errorMsg += '\n\nğŸ’¡ ç½‘ç»œè¿æ¥é—®é¢˜ï¼š\n1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸\n2. ä»£ç†æœåŠ¡å¯èƒ½æš‚æ—¶ä¸å¯ç”¨\n3. ç¨åé‡è¯•\n\nğŸ’¡ å¦‚æœé—®é¢˜æŒç»­ï¼Œå¯ä»¥åˆ‡æ¢åˆ°API Keyæ¨¡å¼';
                } else if (error.message.includes('API Key') || error.message.includes('401') || error.message.includes('403') || error.message.includes('Token')) {
                    errorMsg += '\n\nğŸ’¡ Tokenå¯èƒ½æ— æ•ˆæˆ–å·²è¿‡æœŸï¼š\n1. ç‚¹å‡»å³ä¸Šè§’âš™ï¸æŒ‰é’®\n2. æ£€æŸ¥Tokenæ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆåº”ä»¥hf_å¼€å¤´ï¼‰\n3. ç¡®è®¤Tokenæƒé™è¶³å¤Ÿï¼ˆéœ€è¦readæƒé™ï¼‰\n4. å¦‚æœTokenå·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ\n\nğŸ”— è·å–æ–°çš„Hugging Face Access Tokenï¼šhttps://huggingface.co/settings/tokens';
                } else if (error.message.includes('Hugging Face APIé”™è¯¯')) {
                    // æ˜¾ç¤ºè¯¦ç»†çš„APIé”™è¯¯ä¿¡æ¯
                    errorMsg += `\n\n${error.message}\n\nğŸ’¡ å¯èƒ½çš„åŸå› ï¼š\n1. Tokenæ— æ•ˆæˆ–å·²è¿‡æœŸ\n2. Tokenæƒé™ä¸è¶³\n3. æ¨¡å‹æš‚æ—¶ä¸å¯ç”¨\n4. APIé…é¢å·²ç”¨å®Œ\n\nğŸ”§ è§£å†³æ–¹æ³•ï¼š\n1. æ£€æŸ¥Tokenæ˜¯å¦æ­£ç¡®ï¼ˆæ ¼å¼ï¼šhf_xxxxxï¼‰\n2. ç¡®è®¤Tokenæœ‰readæƒé™\n3. å¦‚æœé—®é¢˜æŒç»­ï¼Œå°è¯•é‡æ–°ç”ŸæˆToken\n\nğŸ”— é‡æ–°ç”ŸæˆTokenï¼šhttps://huggingface.co/settings/tokens`;
                } else {
                    errorMsg += `\n\né”™è¯¯è¯¦æƒ…ï¼š${error.message}\n\nğŸ’¡ è¯·ç‚¹å‡»å³ä¸Šè§’âš™ï¸æ£€æŸ¥é…ç½®æˆ–åˆ‡æ¢åˆ°API Keyæ¨¡å¼`;
                }
                
                addMessageToChat('assistant', errorMsg);
            } finally {
                // æ¢å¤è¾“å…¥å’ŒæŒ‰é’®
                input.disabled = false;
                document.getElementById('chatSendBtn').disabled = false;
                input.focus();
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©çª—å£
        function addMessageToChat(role, content, animate = true) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${role}`;
            
            const avatar = role === 'user' ? 'ğŸ˜Š' : 'ğŸ¤—';
            messageDiv.innerHTML = `
                <div class="message-avatar">${avatar}</div>
                <div class="message-content">${content.replace(/\n/g, '<br>')}</div>
            `;

            if (animate) {
                messageDiv.style.animation = 'fadeIn 0.3s ease-out';
            }

            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // æ˜¾ç¤º/éšè—æ‰“å­—æŒ‡ç¤ºå™¨
        function showTypingIndicator() {
            const chatMessages = document.getElementById('chatMessages');
            const indicator = document.createElement('div');
            indicator.className = 'chat-message assistant';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = `
                <div class="message-avatar">ğŸ¤—</div>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            chatMessages.appendChild(indicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // å¤„ç†è¾“å…¥æ¡†å›è½¦
        function handleChatInputKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendChatMessage();
            }
        }

        // APIé…ç½®ç›¸å…³
        let selectedApiOption = 'ollama';

        function selectApiOption(provider) {
            selectedApiOption = provider;
            document.querySelectorAll('.api-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function showApiConfig() {
            const modal = document.getElementById('apiConfigModal');
            const config = Assistant.getApiConfig();
            // å¼ºåˆ¶ä½¿ç”¨huggingfaceä½œä¸ºé»˜è®¤é€‰é¡¹ï¼ˆé€šè¿‡Gitéƒ¨ç½²åï¼Œä»£ç†ä¼šè‡ªåŠ¨å¤„ç†API Keyï¼‰
            selectedApiOption = 'huggingface';

            // æ¢å¤é…ç½®å€¼
            if (config.ollama) {
                document.getElementById('ollamaUrl').value = config.ollama.url || 'http://localhost:11434/api/chat';
                document.getElementById('ollamaModel').value = config.ollama.model || 'llama3.2';
            }
            if (config.huggingface) {
                document.getElementById('hfApiKey').value = config.huggingface.apiKey || '';
                document.getElementById('hfModel').value = config.huggingface.model || 'meta-llama/Llama-3.2-3B-Instruct';
            }
            if (config.groq) {
                document.getElementById('groqApiKey').value = config.groq.apiKey || '';
                document.getElementById('groqModel').value = config.groq.model || 'llama-3.1-8b-instant';
            }
            if (config.openai) {
                document.getElementById('openaiApiKey').value = config.openai.apiKey || '';
                document.getElementById('openaiModel').value = config.openai.model || 'gpt-3.5-turbo';
            }

            // é«˜äº®é€‰ä¸­çš„é€‰é¡¹
            document.querySelectorAll('.api-option').forEach((opt, index) => {
                const providers = ['ollama', 'huggingface', 'groq', 'openai'];
                opt.classList.remove('selected');
                if (providers[index] === selectedApiOption) {
                    opt.classList.add('selected');
                }
            });

            modal.classList.add('show');
            
            // å¦‚æœHugging Face Access Tokenä¸ºç©ºï¼Œè‡ªåŠ¨èšç„¦åˆ°è¾“å…¥æ¡†å¹¶æ»šåŠ¨åˆ°è¯¥é€‰é¡¹
            if (selectedApiOption === 'huggingface') {
                setTimeout(() => {
                    const hfOption = document.querySelector('.api-option[onclick*="huggingface"]');
                    if (hfOption) {
                        hfOption.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    const apiKeyInput = document.getElementById('hfApiKey');
                    if (apiKeyInput && !config.huggingface.apiKey) {
                        apiKeyInput.focus();
                        apiKeyInput.style.borderColor = '#667eea';
                        apiKeyInput.style.borderWidth = '2px';
                    }
                }, 300);
            }
        }

        function closeApiConfig() {
            document.getElementById('apiConfigModal').classList.remove('show');
        }

        function saveApiConfig() {
            const config = {
                provider: selectedApiOption,
                ollama: {
                    url: document.getElementById('ollamaUrl').value.trim(),
                    model: document.getElementById('ollamaModel').value.trim()
                },
                huggingface: {
                    apiKey: document.getElementById('hfApiKey').value.trim(),
                    model: document.getElementById('hfModel').value.trim()
                },
                groq: {
                    apiKey: document.getElementById('groqApiKey').value.trim(),
                    model: document.getElementById('groqModel').value.trim()
                },
                openai: {
                    apiKey: document.getElementById('openaiApiKey').value.trim(),
                    model: document.getElementById('openaiModel').value.trim()
                }
            };

            // éªŒè¯é…ç½®
            if (config.provider === 'huggingface' && !config.huggingface.apiKey) {
                alert('è¯·å…ˆè¾“å…¥Hugging Face Access Token');
                document.getElementById('hfApiKey').focus();
                return;
            }
            if (config.provider === 'groq' && !config.groq.apiKey) {
                alert('è¯·å…ˆè¾“å…¥Groq API Key');
                document.getElementById('groqApiKey').focus();
                return;
            }
            if (config.provider === 'openai' && !config.openai.apiKey) {
                alert('è¯·å…ˆè¾“å…¥OpenAI API Key');
                document.getElementById('openaiApiKey').focus();
                return;
            }

            Assistant.saveApiConfig(config);
            closeApiConfig();
            
            // æ˜¾ç¤ºä¿å­˜æˆåŠŸæç¤º
            const providerNames = {
                'huggingface': 'Hugging Face',
                'groq': 'Groq',
                'ollama': 'Ollama',
                'openai': 'OpenAI'
            };
            
            addMessageToChat('assistant', `âœ… ${providerNames[config.provider] || 'API'}é…ç½®å·²ä¿å­˜ï¼ç°åœ¨å¯ä»¥å¼€å§‹èŠå¤©äº†ï½\n\nè¯•è¯•é—®æˆ‘ï¼š"ä½ ä»Šå¤©æ„Ÿè§‰æ€ä¹ˆæ ·ï¼Ÿ"`, false);
        }

        // åŸå› æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        reasonButtons.forEach(button => {
            button.addEventListener('click', function() {
                const reason = this.getAttribute('data-reason');
                
                // ç§»é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
                reasonButtons.forEach(btn => btn.classList.remove('selected'));
                
                // æ·»åŠ é€‰ä¸­çŠ¶æ€åˆ°å½“å‰æŒ‰é’®
                this.classList.add('selected');
                
                // ä¿å­˜å¿ƒæƒ…è®°å½•ï¼ˆéš¾è¿‡ + åŸå› ï¼‰
                saveMoodRecord('sad', reason);
                
                // ä¿å­˜å½“å‰å¿ƒæƒ…ï¼ˆç”¨äºæ—¥è®°å’ŒéŸ³ä¹æ¨èï¼‰
                Storage.setCurrentMood('sad');
                
                // æ›´æ–°æ‰“å¡å¤©æ•°
                const newStreak = updateStreak();
                
                // æ›´æ–°æ‰“å¡æé†’
                showCheckinReminder();
                
                // ç¡®ä¿å†å²è®°å½•æŒ‰é’®å­˜åœ¨
                ensureHistoryButton();
                
                // è·å–å¯¹åº”çš„å¼€å¯¼è¯­è¨€
                const reasonMsgList = reasonMessages[reason];
                const randomMessage = reasonMsgList[Math.floor(Math.random() * reasonMsgList.length)];
                
                // æ˜¾ç¤ºæ¶ˆæ¯
                messageElement.classList.remove('show');
                setTimeout(() => {
                    messageElement.textContent = randomMessage;
                    messageElement.classList.add('show');
                }, 50);

                // è‡ªåŠ¨æ˜¾ç¤ºéŸ³ä¹æ¨è
                setTimeout(() => {
                    showMusicRecommendations('sad');
                }, 800);

                // å¦‚æœæœ‰å†å²è®°å½•åŒºåŸŸï¼Œæ›´æ–°å›¾è¡¨
                const historySection = document.getElementById('historySection');
                if (historySection && historySection.style.display !== 'none') {
                    renderHistoryChart();
                }
            });
        });

        // è¿”å›æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        backToMoodBtn.addEventListener('click', function() {
            reasonSelection.classList.remove('show');
            moodSelection.classList.remove('hidden');
            messageElement.classList.remove('show');
            messageElement.textContent = '';
            
            // æ¸…é™¤åŸå› æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            reasonButtons.forEach(btn => btn.classList.remove('selected'));
            
            // æ¸…é™¤å¿ƒæƒ…æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
            moodButtons.forEach(btn => btn.classList.remove('selected'));
        });
    </script>
</body>
</html>